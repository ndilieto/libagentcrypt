<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>libagentcrypt: A library for symmetric encryption with SSH Agent</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libagentcrypt
   &#160;<span id="projectnumber">1.0.6</span>
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',false,false,'search.php','Search');
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">A library for symmetric encryption with SSH Agent </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3>Copyright (c) 2019-2022, Nicola Di Lieto <a href="#" onclick="location.href='mai'+'lto:'+'nic'+'ol'+'a.d'+'il'+'iet'+'o@'+'gma'+'il'+'.co'+'m'; return false;">nicol<span style="display: none;">.nosp@m.</span>a.di<span style="display: none;">.nosp@m.</span>lieto<span style="display: none;">.nosp@m.</span>@gma<span style="display: none;">.nosp@m.</span>il.co<span style="display: none;">.nosp@m.</span>m</a></h3>
<p>Permission to use, copy, modify, and/or distribute this software for any purpose with or without fee is hereby granted, provided that the above copyright notice and this permission notice appear in all copies.</p>
<p>THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</p>
<h1>Introduction</h1>
<p>libagentcrypt allows using the keys in the SSH Agent to perform symmetric, authenticated encryption and decryption securely without typing passwords. It works with both RSA and ED25519 SSH keys including those made available to a remote host by SSH Agent forwarding. The library is based on strong encryption routines from <a href="https://www.libsodium.org">libsodium</a>. The source code is maintained on <a href="https://github.com/ndilieto/libagentcrypt">github</a>.</p>
<h1>Algorithms</h1>
<p>The SSH Agent protocol only allows the use of ssh keys for signing data. Therefore libagentcrypt performs the following process for every symmetric encryption (<a class="el" href="libagentcrypt_8h.html#af2edc5b8b7ab4c5ebab073315f3d1caf" title="Encrypt and authenticate a block of data, for later decryption by agc_decrypt() ">agc_encrypt()</a> function):</p><ul>
<li>pad the cleartext with random data to a size multiple of the padding size (to hide true message length) and concatenate the original length at the end of the cleartext</li>
<li>generate a random hash key</li>
<li>create a nonce by hashing the padded cleartext with the random hash key</li>
<li>create a challenge by concatenating nonce and ssh key fingerprint</li>
<li>submit the challenge to the SSH Agent for signing with the ssh key</li>
<li>compute the symmetric key by hashing the agent signature data</li>
<li>encrypt and authenticate the padded cleartext with the nonce and the symmetric key (using libsodium's crypto_secretbox algorithm)</li>
<li>output the challenge and ciphertext</li>
</ul>
<p>The decryption process (<a class="el" href="libagentcrypt_8h.html#a0539aac42176c2bf7115ed55cd41a41c" title="Decrypt and verify a block of data encrypted by agc_encrypt() ">agc_decrypt()</a> function) is the reverse:</p><ul>
<li>read the challenge and the ciphertext</li>
<li>submit the challenge to the SSH agent for signing</li>
<li>compute the symmetric key by hashing the agent signature data</li>
<li>decrypt and verify the ciphertext</li>
<li>read the original length at the end of the decrypted data and strip the padding bytes</li>
<li>output the cleartext</li>
</ul>
<p>Both <a class="el" href="libagentcrypt_8h.html#af2edc5b8b7ab4c5ebab073315f3d1caf" title="Encrypt and authenticate a block of data, for later decryption by agc_decrypt() ">agc_encrypt()</a> and <a class="el" href="libagentcrypt_8h.html#a0539aac42176c2bf7115ed55cd41a41c" title="Decrypt and verify a block of data encrypted by agc_encrypt() ">agc_decrypt()</a> are intended to encrypt short blocks of data stored in memory. Two additional functions are also provided to encrypt and decrypt files of arbitrary length: <a class="el" href="libagentcrypt_8h.html#a2f95c12bba3517287dc11017325a53c0" title="Encrypt a file for later decryption by agc_fdecrypt() ">agc_fencrypt()</a> generates a random key, encrypts it with <a class="el" href="libagentcrypt_8h.html#af2edc5b8b7ab4c5ebab073315f3d1caf" title="Encrypt and authenticate a block of data, for later decryption by agc_decrypt() ">agc_encrypt()</a> and stores it at the beginning of the output; it then uses the random key to encrypt the file with libsodium's crypto_secretstream algorithm. <a class="el" href="libagentcrypt_8h.html#a65bac94e1760a518cbae4748170a3f14" title="Decrypt a file encrypted by agc_fencrypt() ">agc_fdecrypt()</a> later reconstructs the key with <a class="el" href="libagentcrypt_8h.html#a0539aac42176c2bf7115ed55cd41a41c" title="Decrypt and verify a block of data encrypted by agc_encrypt() ">agc_decrypt()</a> and can then decrypt the file.</p>
<p>Two helper functions (<a class="el" href="libagentcrypt_8h.html#a199ce908194e9543ab79e63a48af5758" title="Decode a string (base64 format with no padding) to a block of data. ">agc_from_b64()</a> and <a class="el" href="libagentcrypt_8h.html#a10f101e8d7e6f43c6b8f5e8c12722202" title="Encode a block of data into a string (base64 format with no padding) ">agc_to_b64()</a>) are included to encode and decode binary data to/from base64 format. These are very useful when encrypted data must be stored in text/configuration files.</p>
<h2>Installation</h2>
<pre class="fragment">export PKG_URL=https://github.com/ndilieto/libagentcrypt/archive/upstream/latest.tar.gz
mkdir -p libagentcrypt
wget -O - $PKG_URL | tar zx -C libagentcrypt --strip-components=1
cd libagentcrypt
./configure --disable-maintainer-mode
make install
</pre><h2>Usage</h2>
<p>SSH currently supports four types of keys:</p><ul>
<li>ED25519</li>
<li>RSA</li>
<li>DSA</li>
<li>ECDSA</li>
</ul>
<p>Signatures made by the first two (ED25519 and RSA) are deterministic, i.e. repeatedly signing the same block of input data always produces the same result. This is not true for DSA and ECDSA keys, therefore libagentcrypt cannot possibly function with these - it would still encrypt but of course the symmetric key would never be able to be recovered. The encryption functions in libagentcrypt check the key type and fail if it it is not one of RSA or ED25519. Fortunately DSA is obsolete and ECDSA may even have a NSA backdoor... RSA is still secure as long as the key size is at least 2048. For best security ED25519 keys are recommended.</p>
<p>The <a href="agentcrypt.1.html"><b>agentcrypt</b></a> command line utility shows how to use the library.</p>
<h1>API Information</h1>
<h2>Headers</h2>
<p>To use libagentcrypt functions in your code you should include the <a class="el" href="libagentcrypt_8h.html">libagentcrypt.h</a> header, i.e.</p><div class="fragment"><div class="line"><span class="preprocessor">#include &lt;<a class="code" href="libagentcrypt_8h.html">libagentcrypt.h</a>&gt;</span> </div></div><!-- fragment --><h2>Namespace</h2>
<p>All identifiers defined by the <a class="el" href="libagentcrypt_8h.html">libagentcrypt.h</a> header use the prefix agc_</p>
<h2>Functions</h2>
<p>The following functions are provided by the library:</p><ul>
<li><a class="el" href="libagentcrypt_8h.html#af2edc5b8b7ab4c5ebab073315f3d1caf" title="Encrypt and authenticate a block of data, for later decryption by agc_decrypt() ">agc_encrypt()</a></li>
<li><a class="el" href="libagentcrypt_8h.html#a0539aac42176c2bf7115ed55cd41a41c" title="Decrypt and verify a block of data encrypted by agc_encrypt() ">agc_decrypt()</a></li>
<li><a class="el" href="libagentcrypt_8h.html#a2f95c12bba3517287dc11017325a53c0" title="Encrypt a file for later decryption by agc_fdecrypt() ">agc_fencrypt()</a></li>
<li><a class="el" href="libagentcrypt_8h.html#a65bac94e1760a518cbae4748170a3f14" title="Decrypt a file encrypted by agc_fencrypt() ">agc_fdecrypt()</a></li>
<li><a class="el" href="libagentcrypt_8h.html#a199ce908194e9543ab79e63a48af5758" title="Decode a string (base64 format with no padding) to a block of data. ">agc_from_b64()</a></li>
<li><a class="el" href="libagentcrypt_8h.html#a10f101e8d7e6f43c6b8f5e8c12722202" title="Encode a block of data into a string (base64 format with no padding) ">agc_to_b64()</a></li>
<li><a class="el" href="libagentcrypt_8h.html#a2b4a0b1adfdf77fe29ed53c57cf74bce" title="Zero fill, unlock and free a dynamically allocated secure buffer. ">agc_free()</a> </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
